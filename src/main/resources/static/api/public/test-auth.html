<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT ì¸ì¦ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="test-auth.css">
</head>
<body>
<div class="container">
    <h1>JWT ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>

    <!-- í† í° ë°œê¸‰ ì„¹ì…˜ -->
    <div class="section">
        <h2>1. JWT í† í° ë°œê¸‰</h2>
        <div>
            <label>ì‚¬ìš©ì ID:</label>
            <input type="text" id="opaqueId" value="550e8400-e29b-41d4-a716-446655440000" placeholder="ì‚¬ìš©ì ID ì…ë ¥">
        </div>
        <div class="button-group">
            <button class="token-btn" onclick="generateToken('MEMBER')">MEMBER í† í° ë°œê¸‰</button>
            <button class="token-btn" onclick="generateToken('ADMIN')">ADMIN í† í° ë°œê¸‰</button>
            <button class="clear-btn" onclick="clearToken()">í† í° ì´ˆê¸°í™”</button>
        </div>
        <div id="tokenDisplay" class="token-display" style="display: none;">
            <strong>ë°œê¸‰ëœ í† í°:</strong><br>
            <span id="tokenValue"></span>
        </div>
        <div class="info">
            í† í°ì€ 5ë¶„ê°„ ìœ íš¨í•˜ë©°, Authorization í—¤ë”ì— 'Bearer {token}' í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
        </div>
    </div>

    <!-- API í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="section">
        <h2>2. API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸</h2>
        <div class="button-group">
            <button class="api-btn" onclick="testApi('/api/public/test', false)">Public API (ì¸ì¦ ë¶ˆí•„ìš”)</button>
            <button class="api-btn" onclick="testApi('/api/test', true)" id="authBtn">Authenticated API (ë¡œê·¸ì¸ í•„ìš”)</button>
            <button class="api-btn" onclick="testApi('/api/admin/test', true)" id="adminBtn">Admin API (ê´€ë¦¬ì ê¶Œí•œ)</button>
        </div>
        <div class="info">
            í† í° ì—†ì´ë„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ 401/403 ì—ëŸ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <div class="button-group">
            <button class="clear-btn" onclick="clearResults()">ê²°ê³¼ ì´ˆê¸°í™”</button>
        </div>
        <div id="apiResults" class="result"></div>
    </div>

    <!-- í˜„ì¬ í† í° ì •ë³´ -->
    <div class="section">
        <h2>3. í˜„ì¬ í† í° ì •ë³´</h2>
        <div id="tokenInfo" class="result">í† í°ì´ ë°œê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
    </div>
</div>

<script>
    let currentToken = null;
    let currentRole = null;

    // í† í° ë°œê¸‰
    async function generateToken(role) {
        const opaqueId = document.getElementById('opaqueId').value;

        try {
            const response = await fetch(`/api/public/token?opaqueId=${encodeURIComponent(opaqueId)}&roleString=${role}`, {
                method: 'GET'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const responseData = await response.json();
            console.log('í† í° ë°œê¸‰ ì‘ë‹µ:', responseData); // ë””ë²„ê¹…ìš©

            if (responseData.success && responseData.data) {
                // í† í° ì •ë³´ ì €ì¥
                currentToken = responseData.data.token;
                currentRole = responseData.data.role;

                // í† í° í‘œì‹œ
                const tokenValueElement = document.getElementById('tokenValue');
                const tokenDisplayElement = document.getElementById('tokenDisplay');

                tokenValueElement.textContent = responseData.data.token;
                tokenDisplayElement.style.display = 'block';

                // í† í° ì •ë³´ í‘œì‹œ
                updateTokenInfo(responseData.data);

                // API ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                updateApiButtons();

                addResult(`âœ… ${responseData.message}\n${JSON.stringify(responseData, null, 2)}`, 'success');
            } else {
                addResult(`âŒ í† í° ë°œê¸‰ ì‹¤íŒ¨: ${responseData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}\n${JSON.stringify(responseData, null, 2)}`, 'error');
            }

        } catch (error) {
            addResult(`âŒ í† í° ë°œê¸‰ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // API í…ŒìŠ¤íŠ¸
    async function testApi(endpoint, requiresAuth) {
        try {
            const headers = {
                'Content-Type': 'application/json'
            };

            // í† í°ì´ ìˆìœ¼ë©´ í•­ìƒ í—¤ë”ì— í¬í•¨ (ì—ëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ í† í° ì—†ì´ë„ í˜¸ì¶œ ê°€ëŠ¥)
            if (currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }

            const response = await fetch(endpoint, {
                method: 'GET',
                headers: headers
            });

            const responseText = await response.text();
            let responseData;

            try {
                responseData = JSON.parse(responseText);
            } catch {
                responseData = responseText;
            }

            if (response.ok) {
                // ì„±ê³µ ì‘ë‹µ (SuccessResponse í˜•ì‹)
                addResult(`âœ… ${endpoint} í˜¸ì¶œ ì„±ê³µ (${response.status})\n${JSON.stringify(responseData, null, 2)}`, 'success');
            } else {
                // ì‹¤íŒ¨ ì‘ë‹µ (FailResponse í˜•ì‹ - GlobalExceptionHandlerì—ì„œ ì²˜ë¦¬)
                addResult(`âŒ ${endpoint} í˜¸ì¶œ ì‹¤íŒ¨ (${response.status})\n${JSON.stringify(responseData, null, 2)}`, 'error');
            }

        } catch (error) {
            addResult(`âŒ ${endpoint} í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
    }

    // ê²°ê³¼ í‘œì‹œ
    function addResult(message, type) {
        const results = document.getElementById('apiResults');
        const timestamp = new Date().toLocaleTimeString();
        results.textContent += `[${timestamp}] ${message}\n\n`;
        results.className = `result ${type}`;
        results.scrollTop = results.scrollHeight;
    }

    // í† í° ì •ë³´ ì—…ë°ì´íŠ¸
    function updateTokenInfo(tokenData) {
        const info = document.getElementById('tokenInfo');
        info.textContent = `ì‚¬ìš©ì ID: ${tokenData.opaqueId}\nì—­í• : ${tokenData.role}\nì‚¬ìš©ë²•: ${tokenData.usage}`;
        info.className = 'result success';
    }

    // API ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œê°ì  í‘œì‹œë§Œ)
    function updateApiButtons() {
        const authBtn = document.getElementById('authBtn');
        const adminBtn = document.getElementById('adminBtn');

        if (currentToken) {
            authBtn.classList.remove('no-token');
            adminBtn.classList.remove('no-token');
        } else {
            authBtn.classList.add('no-token');
            adminBtn.classList.add('no-token');
        }
    }

    // í† í° ì´ˆê¸°í™”
    function clearToken() {
        currentToken = null;
        currentRole = null;
        document.getElementById('tokenDisplay').style.display = 'none';
        document.getElementById('tokenInfo').textContent = 'í† í°ì´ ë°œê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
        document.getElementById('tokenInfo').className = 'result';
        updateApiButtons();
        addResult('ğŸ§¹ í† í°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ê²°ê³¼ ì´ˆê¸°í™”
    function clearResults() {
        document.getElementById('apiResults').textContent = '';
        document.getElementById('apiResults').className = 'result';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
        updateApiButtons();
    };
</script>
</body>
</html>
